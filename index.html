<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ads Management</title>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,900;1,200;1,300;1,400;1,500;1,600&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    <!-- Bootstrap Datatables -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/select/1.7.0/css/select.bootstrap5.min.css"
    />

    <!-- Bootstrap-table -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"
    />

    <!-- Bootstrap-table -->
    <script defer src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script
      defer
      src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"
    ></script>
    <script
      defer
      src="https://unpkg.com/bootstrap-table@1.22.1/dist/locale/bootstrap-table-vi-VN.min.js"
    ></script>
    <script
      defer
      src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"
    ></script>
    <script defer src="js/table.js"></script>
    <script
      defer
      type="module"
      crossorigin="anonymous"
      src="js/script.js"
    ></script>

    <!-- CSS stylesheets -->
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/sidebar.css" />
    <link rel="stylesheet" href="css/all.css" />
    <!-- Bootstrap icon -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <!-- Mapbox -->
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <!--- Load the mapbox geocoder plugin -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
      type="text/css"
    />
    <aside class="position-absolute z-3 h-100">
      <!-- Sidebar -->
      <div class="d-flex flex-column p-0 flex-shrink-0 sidebar-wrap">
        <a
          href="/"
          class="d-block p-3 link-body-emphasis text-decoration-none logo-wrap"
          data-bs-toggle="tooltip"
          data-bs-placement="right"
          data-bs-original-title="Icon only"
        >
          <div class="icon-wrap">
            <i class="fa-duotone fa-map"></i>
          </div>
        </a>
        <!-- <hr /> -->
        <ul class="nav nav-pills nav-flush flex-column mb-auto text-center">
          <li class="nav-item">
            <a
              href="/"
              class="nav-link rounded-0 py-3 border-bottom border-dark active"
              aria-current="page"
              data-bs-toggle="tooltip"
              data-bs-placement="right"
              aria-label="Trang chủ"
              data-bs-original-title="Trang chủ"
            >
              <i class="fa-regular fa-house"></i>
              <span>Trang chủ</span>
            </a>
          </li>
          <ul class="nav nav-pills nav-flush flex-column mb-auto text-center">
            <li class="nav-item">
              <a
                href="/reports.html"
                class="nav-link rounded-0 py-3"
                aria-current="page"
                data-bs-toggle="tooltip"
                data-bs-placement="right"
                aria-label="Trang chủ"
                data-bs-original-title="Trang chủ"
              >
                <i class="fa-regular fa-pen-nib"></i>
                <span>Danh sách báo cáo</span>
              </a>
            </li>
          </ul>
        </ul>
      </div>
    </aside>

    <main class="container-fluid d-flex bg-light p-0">
      <div id="map"></div>
      <div
        id="bottom-menu"
        class="container-lg mb-3 mx-3 p-2 bg-white position-absolute bottom-0 z-index-3"
        style="left: 5rem"
      >
        <div
          id="toggle-container"
          class="row align-items-center justify-content-start mx-2"
        >
          <div class="col-3">
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="ads-toggle"
                aria-checked="false"
                checked
              />
              <label class="form-check-label" for="ads-toggle"
                >Bảng quảng cáo</label
              >
            </div>
          </div>

          <div class="col-3">
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="report-toggle"
                aria-checked="false"
                checked
              />
              <label class="form-check-label" for="report-toggle"
                >Báo cáo vi phạm</label
              >
            </div>
          </div>

          <div class="col-3">
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="planned-toggle"
                aria-checked="false"
                checked
              />
              <label class="form-check-label" for="planned-toggle"
                >Đã quy hoạch</label
              >
            </div>
          </div>

          <div class="col-3">
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="all-toggle"
                aria-checked="false"
                checked
              />
              <label class="form-check-label" for="all-toggle"
                >Hiện tất cả</label
              >
            </div>
          </div>
        </div>
      </div>
      <div
        class="offcanvas offcanvas-end"
        tabindex="-1"
        id="offcanvasSpotDetail"
        aria-labelledby="offcanvasSpotDetailLabel"
      >
        <div class="offcanvas-header container-fluid">
          <img
            loading="lazy"
            decoding="async"
            src="assets/san-cau-long-phu-tho-1.webp"
            class="img-fluid"
            alt="Nhà thi đấu Phú Thọ"
            style="background-size: cover; margin: 0; content-visibility: auto"
          />
          <h4
            class="offcanvas-title fw-bold text-uppercase mt-3"
            id="offcanvasSpotDetailLabel"
          >
            Nhà thi đấu Phú Thọ
          </h4>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
            id="btn-close"
          ></button>
        </div>
        <div class="offcanvas-body">
          <ul class="nav nav-tabs">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="info-tab"
                data-bs-toggle="tab"
                data-bs-target="#info-tab-pane"
                type="button"
                role="tab"
                aria-controls="info-tab-pane"
                aria-selected="true"
              >
                Thông tin
              </button>
            </li>
            <li class="nav-item">
              <button
                class="nav-link"
                id="ads-tab"
                data-bs-toggle="tab"
                data-bs-target="#ads-tab-pane"
                type="button"
                role="tab"
                aria-controls="ads-tab-pane"
                aria-selected="false"
              >
                B.Quảng cáo
              </button>
            </li>
            <li class="nav-item">
              <button
                class="nav-link"
                id="report-tab"
                data-bs-toggle="tab"
                data-bs-target="#report-tab-pane"
                type="button"
                role="tab"
                aria-controls="report-tab-pane"
                aria-selected="false"
              >
                Báo cáo
              </button>
            </li>
          </ul>

          <div class="tab-content" id="tabContent">
            <div
              class="tab-pane fade show active"
              id="info-tab-pane"
              role="tabpanel"
              aria-labelledby="info-tab"
              tabindex="0"
            ></div>
            <div
              class="tab-pane list-group fade p-0 overflow-auto"
              id="ads-tab-pane"
              role="tabpanel"
              aria-labelledby="ads-tab"
              tabindex="0"
            ></div>
            <div
              class="tab-pane list-group fade p-0 overflow-auto"
              id="report-tab-pane"
              role="tabpanel"
              aria-labelledby="report-tab"
              tabindex="0"
            ></div>
          </div>
        </div>
      </div>
    </main>
    <!-- Script -->
    <script
      src="https://code.jquery.com/jquery-3.7.0.min.js"
      integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    <script defer type="module">
      import { getDetailSpot } from "./js/request.js";

      let setupData = true;

      const formatter = new Intl.DateTimeFormat("vi-VN", {
        // <- re-use me
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
      });

      document
        .getElementById("offcanvasSpotDetail")
        .addEventListener("show.bs.offcanvas", async (e) => {
          console.log(e);
          if (setupData) {
            setupData = false;
            return;
          }
          e.preventDefault();
          const spotID = e.relatedTarget.dataset.bsSpotId;
          let detailSpot = await getDetailSpot(spotID);
          detailSpot = detailSpot[0];
          console.log(detailSpot);

          // attach data to offcanvas
          const offcanvas = document.getElementById("offcanvasSpotDetail");
          offcanvas.dataset.bsSpotId = spotID;

          // update offcanvas header
          const offcanvasHeader = offcanvas.querySelector(".offcanvas-header");
          offcanvasHeader.querySelector("img").src = detailSpot.spotImage[0];
          offcanvasHeader.querySelector(
            "#offcanvasSpotDetailLabel"
          ).textContent = detailSpot.spotName;

          // update info tab pane
          const infoTabPane = offcanvas.querySelector("#info-tab-pane");
          const infoHTML = `<p>Địa chỉ: <b>${detailSpot.address}</b></p>
      <p>Loại hình: <b>${detailSpot.adsFormName}</b></p>
      <p>Hình thức: <b>${detailSpot.spotTypeName} </b></p>
      <p class="text-uppercase fw-bold fst-italic">${detailSpot.planned}</p>
      <div class="options">
            <a href="spot-detail.html?id=${detailSpot.spotID}" class="btn btn-icon" role="button">
              <i class="bi bi-info-circle"></i>
            </a>
            <a href="report-create.html?id=${detailSpot.spotID}" class="btn btn-outline-danger">
              <i class="bi bi-exclamation-octagon"></i>
              Báo cáo vi phạm
            </a>
          </div>`;
          infoTabPane.innerHTML = infoHTML;

          // update ads tab pane
          const adsTabPane = offcanvas.querySelector("#ads-tab-pane");
          const adsHTML = detailSpot.boards.map(
            (ad) => `<div class="list-group-item list-group-item-action">
                    <h5 class="mb-1 fw-semibold">${ad.boardType}</h5>
                    <small>${detailSpot.address}</small>
                    <p class="mb-1">Kích thước: <b>${ad.boardSize}m</b></p>
                    <p class="mb-1">Số lượng: <b>${ad.quantity}<b></p>
                    <p class="mb-1">Hình thức: <b>${detailSpot.adsFormName}</b></p>
                    <p class="mb-1">Loại hình: <b>${detailSpot.spotTypeName}</b></p>
                    <div class="options">
                      <a href="board-detail.html?id=${ad.boardID}" class="btn btn-icon" role="button"><i class="bi bi-info-circle"></i></a>
			              	<a href="report-create.html?id=${ad.boardID}" class="btn btn-outline-danger" role="button"><i class="bi bi-exclamation-octagon"></i> Báo cáo vi phạm</a>
                    </div>
                    </div>`
          );
          // check if adsHTML is empty hide ads tab pane, also hide ads toggle
          if (adsHTML.length == 0) {
            console.log("empty");
            adsTabPane.classList.add("d-none");
            document
              .getElementById("ads-tab")
              .parentElement.classList.add("d-none");
          } else {
            adsTabPane.innerHTML = "";
            adsTabPane.classList.remove("d-none");
            document
              .getElementById("ads-tab")
              .parentElement.classList.remove("d-none");
          }

          adsHTML.forEach((html) => {
            let newItem = new DOMParser().parseFromString(html, "text/html")
              .body.firstChild;
            adsTabPane.appendChild(newItem);
          });

          // update report tab pane
          // combine report of spot and report of boards

          let reports = detailSpot.reports;
          detailSpot.boards.forEach((board) => {
            reports = reports.concat(board.reports);
          });

          // sort report by sendTimee
          reports = reports.sort((a, b) =>
            a.sendTime.localeCompare(b.sendTime)
          );
          console.log(reports);

          const reportTabPane = offcanvas.querySelector("#report-tab-pane");
          let reportHTML = reports.map(
            ( report) => `<div class="list-group-item list-group-item-action position-relative">
                          <h5 class="mb-1 fw-semibold">${report.reportType}</h5>
                          <p class="mb-1">${report.reporterName}</p>
                          <p class="mb-1">Ngày gửi: <b>${formatter.format(new Date(report.sendTime))}</b></p>
                          <p class="mb-1">Tình trạng: <b>${report.status ? "Đã xử lý" : "Chưa xử lý"}</b></p>
                          <div class="options">
                            <a href="report-detail.html?id=${
                              report.reportID
                            }" class="btn btn-icon position-absolute top-0 end-0 me-3" role="button"><i class="bi bi-info-circle"></i></a>
                          </div>
                          </div>`
          );

          // check if reportHTML is empty hide report tab pane, also hide report toggle
          if (reportHTML.length == 0) {
            console.log("empty");
            reportTabPane.classList.add("d-none");
            document
              .getElementById("report-tab")
              .parentElement.classList.add("d-none");
          } else {
            reportTabPane.innerHTML = "";
            reportTabPane.classList.remove("d-none");
            document
              .getElementById("report-tab")
              .parentElement.classList.remove("d-none");
          }

          reportHTML.forEach((html) => {
            let newItem = new DOMParser().parseFromString(html, "text/html")
              .body.firstChild;
            reportTabPane.appendChild(newItem);
          });

          setupData = true;
          $(this).trigger(e.type);
          console.log("done");
        });
    </script>
    <!-- End of Script -->
  </body>
</html>
